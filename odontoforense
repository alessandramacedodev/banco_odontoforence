-- Exclusão das tabelas, se já existirem
DROP TABLE IF EXISTS equipe_caso CASCADE;
DROP TABLE IF EXISTS evidencias CASCADE;
DROP TABLE IF EXISTS anexos_laudos CASCADE;
DROP TABLE IF EXISTS laudos CASCADE;
DROP TABLE IF EXISTS casos_periciais CASCADE;
DROP TABLE IF EXISTS comparacoes CASCADE;
DROP TABLE IF EXISTS registros_odontologicos CASCADE;
DROP TABLE IF EXISTS usuarios CASCADE;

-- Criação da tabela de usuários
CREATE TABLE usuarios (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nome_completo TEXT NOT NULL,
    email TEXT UNIQUE NOT NULL,
    perfil TEXT CHECK (perfil IN ('administrador', 'perito', 'assistente')) NOT NULL,
    status TEXT CHECK (status IN ('concluido', 'em_andamento', 'pendente', 'arquivo')) NOT NULL,
    criado_em TIMESTAMP DEFAULT NOW()
);

-- Registros iniciais
INSERT INTO usuarios (nome_completo, email, perfil, status) VALUES
('Carlos Silva', 'carlos@exemplo.com', 'perito', 'concluido'),
('Ana Pereira', 'ana@exemplo.com', 'assistente', 'em_andamento'),
('Marcos Oliveira', 'marcos@exemplo.com', 'perito', 'pendente'),
('Joana Lima', 'joana@exemplo.com', 'administrador', 'arquivo'),
('Luciana Rocha', 'luciana@exemplo.com', 'assistente', 'concluido');

-- Registros odontológicos
CREATE TABLE registros_odontologicos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tipo TEXT CHECK (tipo IN ('Ante-Mortem', 'Post-Mortem')) NOT NULL,
    data_registro DATE NOT NULL,
    caracteristicas TEXT,
    status TEXT CHECK (status IN ('Identificado', 'Não Identificado')) NOT NULL,
    usuario_id UUID REFERENCES usuarios(id)
);

-- Comparações
CREATE TABLE comparacoes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    registro_ante_mortem_id UUID REFERENCES registros_odontologicos(id),
    registro_post_mortem_id UUID REFERENCES registros_odontologicos(id),
    descricao_resultado TEXT,
    porcentagem_compatibilidade NUMERIC
);

-- Casos periciais
CREATE TABLE casos_periciais (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    numero TEXT NOT NULL,
    descricao TEXT,
    data_abertura DATE,
    status TEXT CHECK (status IN ('Concluído', 'Em Andamento', 'Pendente', 'Arquivado')) NOT NULL,
    local TEXT,
    solicitado_por TEXT,
    perito_responsavel_id UUID REFERENCES usuarios(id)
);

-- Laudos
CREATE TABLE laudos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    numero TEXT NOT NULL,
    titulo TEXT,
    data DATE,
    tipo TEXT CHECK (tipo IN ('Preliminar', 'Final', 'Complementar')) NOT NULL,
    conteudo TEXT,
    caso_id UUID REFERENCES casos_periciais(id),
    autor_id UUID REFERENCES usuarios(id)
);

-- Anexos dos laudos
CREATE TABLE anexos_laudos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    laudo_id UUID REFERENCES laudos(id),
    nome_arquivo TEXT,
    url_arquivo TEXT,
    data_upload DATE DEFAULT CURRENT_DATE
);

-- Evidências
CREATE TABLE evidencias (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    caso_id UUID REFERENCES casos_periciais(id),
    nome TEXT,
    categoria TEXT CHECK (categoria IN ('odontologica', 'documentos', 'fotografias', 'laboratorio', 'outros')),
    data_recebimento DATE,
    descricao TEXT,
    local_retirada TEXT,
    url_arquivo TEXT
);

-- Equipe dos casos
CREATE TABLE equipe_caso (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    caso_id UUID REFERENCES casos_periciais(id),
    usuario_id UUID REFERENCES usuarios(id),
    funcao TEXT
);
